let cart=[];async function loadProducts(q=''){const res=await fetch('/api/products'+(q?('?q='+encodeURIComponent(q)):''));const data=await res.json();const root=document.getElementById('products');if(!root)return;root.innerHTML='';data.forEach(p=>{const card=document.createElement('div');card.className='card';card.innerHTML=`<h4>${p.name}</h4><div>R$ ${p.price.toFixed(2)}</div><div>Estoque: ${p.stock}</div><button ${p.stock<=0?'disabled':''} onclick='addToCart(${p.id})'>Adicionar</button>`;root.appendChild(card);})}function updateCartUI(){const el=document.getElementById('cart-items');if(!el)return;el.innerHTML='';let total=0;cart.forEach(item=>{const row=document.createElement('div');row.innerText=`${item.name} x ${item.qty} â€” R$ ${(item.price*item.qty).toFixed(2)}`;el.appendChild(row);total+=item.price*item.qty;});const tt=document.getElementById('cart-total');if(tt)tt.innerText='Total: R$ '+total.toFixed(2);}async function addToCart(id){const res=await fetch('/api/products/'+id);const p=await res.json();const found=cart.find(i=>i.id===p.id);if(found){if(found.qty+1>p.stock)return alert('Sem estoque suficiente');found.qty++;}else{cart.push({id:p.id,name:p.name,price:p.price,qty:1,stock:p.stock});}updateCartUI();}document.addEventListener('DOMContentLoaded',()=>{const s=document.getElementById('search');if(s){s.addEventListener('input',()=>loadProducts(s.value));}const chk=document.getElementById('checkout');if(chk){chk.addEventListener('click',async()=>{if(cart.length===0)return alert('Carrinho vazio');const payload={cart:cart.map(i=>({id:i.id,qty:i.qty}))};const res=await fetch('/api/checkout',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});const data=await res.json();if(res.ok){alert('Compra finalizada! Total R$ '+data.total.toFixed(2));cart=[];loadProducts();updateCartUI();}else{alert('Erro: '+(data.error||''));}})}loadProducts();})